apiVersion: v1
kind: Service
metadata:
  name: vechr-microservice-service
  labels:
    app: vechr-microservice-application
  annotations:
    # https://console.cloud.google.com/compute/healthChecks
    cloud.google.com/backend-config: 
      '{
        "default": 
          {{range $i, $value := .Values.microservices}}
          "bc-{{$value.name}}",
          {{end}}
      }'
spec:
  type: NodePort
  selector:
    app: vechr-microservice-application
  ports:
    {{range $i, $value := .Values.microservices | default dict}}
    {{if and $value.externalPort $value.enabled}}
    - port: {{$value.externalPort}}
      targetPort: {{$value.externalPort}}
      nodePort: {{$value.nodePort}}
      protocol: TCP
      name: "http-{{$value.name}}"
    {{end}}
    {{end}}